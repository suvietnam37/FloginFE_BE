# Tên của workflow, sẽ hiển thị trên tab "Actions" của GitHub
name: Login Tests CI

# Định nghĩa các sự kiện sẽ kích hoạt workflow này
on:
  # Chạy khi có code được push lên nhánh `main` hoặc `develop`
  push:
    branches: [ main, develop ]
  # Chạy khi có Pull Request được mở hoặc cập nhật nhắm vào nhánh `main`
  pull_request:
    branches: [ main ]

# Định nghĩa các công việc (jobs) sẽ được thực hiện
jobs:
  # Đặt tên cho job, ví dụ: "build-and-test"
  test-login-flow:
    # Chạy job này trên một máy ảo Ubuntu phiên bản mới nhất
    runs-on: ubuntu-latest

    # Định nghĩa các bước (steps) tuần tự trong job
    steps:
      # Bước 1: Lấy mã nguồn từ repository về máy ảo
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- CÀI ĐẶT MÔI TRƯỜNG CHO BACKEND ---
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # --- CÀI ĐẶT MÔI TRƯỜNG CHO FRONTEND ---
      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # Bước 2: Cài đặt các gói phụ thuộc cho Frontend
      - name: Install Frontend Dependencies
        run: npm install --prefix frontend

      # Bước 3: Chạy các bài Unit Test & Integration Test của Backend
      # Lệnh này sẽ chạy tất cả các file test, bao gồm cả AuthSerivceTest và AuthControllerIntegrationTest
      - name: Run Backend Tests
        run: mvn -B test --file backend/pom.xml

      # Bước 4: Chạy các bài Unit Test & Integration Test của Frontend cho Login
      # Chúng ta có thể chỉ định chỉ chạy các file test có tên chứa "Login"
      - name: Run Frontend Login Unit/Integration Tests
        run: npm test --prefix frontend -- src/pages/LoginPage/

      # Bước 5: Chạy E2E Test cho Login bằng Cypress
      # Quan trọng: Cần phải khởi động cả server Backend và Frontend
      # Chúng ta sẽ sử dụng action chính thức của Cypress để làm việc này dễ dàng hơn
      - name: Run Frontend Login E2E Tests with Cypress
        uses: cypress-io/github-action@v6
        with:
          # Thư mục làm việc cho action này
          working-directory: frontend
          # Lệnh để khởi động server backend và chạy nền
          # Cần build backend ra file .jar trước
          # (Lệnh này có thể phức tạp, xem phần lưu ý bên dưới)
          # build: mvn -B package --file ../backend/pom.xml
          # start: java -jar ../backend/target/*.jar & npm run dev
          
          # Cách đơn giản hơn cho bài tập lớn: Test E2E với dữ liệu mock
          # Nếu bạn đã có các bài test E2E không phụ thuộc vào backend thật, bạn chỉ cần chạy:
          start: npm run dev
          # Chỉ định chỉ chạy file test của Login
          spec: cypress/e2e/login.cy.js

      # Bước 6: (Yêu cầu "Generate test reports") - Lưu lại kết quả
      # Upload báo cáo test của Maven (backend)
      - name: Upload Backend Test Reports
        if: always() # Luôn chạy bước này, kể cả khi test thất bại
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-reports
          path: backend/target/surefire-reports/

      # Upload các video và screenshot khi Cypress chạy thất bại
      - name: Upload Frontend E2E Test Artifacts
        if: failure() # Chỉ chạy bước này khi test E2E thất bại
        uses: actions/upload-artifact@v4
        with:
          name: cypress-artifacts
          path: |
            frontend/cypress/videos/
            frontend/cypress/screenshots/